This is kind of ugly code, but it works
